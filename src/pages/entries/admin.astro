---
import Layout from "../../layouts/Layout.astro";
import { AdminEntriesPage } from "../../components/pages";
import { getUserWithApproval } from "../../lib/auth";
import { getAllEntries } from "../../lib/entries";
import { getRevealEntriesSetting } from "../../lib/settings";
import { getUserAdminGames } from "../../lib/games";

const auth = await getUserWithApproval(Astro.request);

if (!auth) {
  return Astro.redirect("/login");
}

if (!auth.isApproved) {
  return Astro.redirect("/unauthorized");
}

// Admin check - return 404 if not admin
if (!auth.isAdmin) {
  return new Response(null, { status: 404 });
}

const { user } = auth;
const [entries, revealEntries, adminGames] = await Promise.all([
  getAllEntries(),
  getRevealEntriesSetting(),
  getUserAdminGames(user.email),
]);
const message = Astro.url.searchParams.get("message");
---

<Layout title="Admin - All Entries - SoupOrBowl 2026">
  <AdminEntriesPage user={user} entries={entries} revealEntries={revealEntries} message={message} adminGames={adminGames} client:load />
</Layout>
