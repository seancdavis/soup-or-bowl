---
import Layout from "../../layouts/Layout.astro";
import { EntriesPage } from "../../components/pages";
import { getUserWithApproval } from "../../lib/auth";
import { getAllEntries } from "../../lib/entries";
import { getRevealEntriesSetting, getRevealResultsSetting } from "../../lib/settings";
import { getWinner } from "../../lib/votes";

const auth = await getUserWithApproval(Astro.request);

if (!auth) {
  return Astro.redirect("/login");
}

if (!auth.isApproved) {
  return Astro.redirect("/unauthorized");
}

const { user } = auth;
const [entries, revealEntries, revealResults] = await Promise.all([
  getAllEntries(),
  getRevealEntriesSetting(),
  getRevealResultsSetting(),
]);

// Only fetch winner if results are revealed
const winner = revealResults ? await getWinner() : null;
---

<Layout title="All Entries - SoupOrBowl 2026">
  <EntriesPage
    user={user}
    entries={entries}
    revealEntries={revealEntries}
    revealResults={revealResults}
    winner={winner}
    isAdmin={auth.isAdmin}
  />
</Layout>
