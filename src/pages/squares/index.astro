---
import Layout from "../../layouts/Layout.astro";
import { GamePickerPage } from "../../components/pages/GamePickerPage";
import { getUserWithApproval } from "../../lib/auth";
import { getUserGames } from "../../lib/games";

const auth = await getUserWithApproval(Astro.request);

if (!auth) {
  return Astro.redirect("/login");
}

const { user, isApproved, isAdmin } = auth;

const userGames = await getUserGames(user.email);

if (userGames.length === 0) {
  return Astro.redirect("/unauthorized");
}

if (userGames.length === 1) {
  return Astro.redirect(`/squares/${userGames[0].slug}`);
}

// 2+ games â€” show game picker
const adminGames = userGames.filter((g) => g.role === "admin").map(({ slug, name }) => ({ slug, name }));
---

<Layout title="Squares - SoupOrBowl 2026">
  <GamePickerPage
    user={user}
    isAdmin={isAdmin}
    isPartyUser={isApproved}
    adminGames={adminGames}
    games={userGames}
  />
</Layout>
