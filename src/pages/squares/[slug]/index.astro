---
import Layout from "../../../layouts/Layout.astro";
import { SquaresLockedPage } from "../../../components/pages";
import { SquaresPickingPageWrapper } from "../../../components/pages/SquaresPickingPageWrapper";
import { getUserWithApproval } from "../../../lib/auth";
import { getGameBySlug, getUserGameAccess, isGameAdmin, getUserAdminGames } from "../../../lib/games";
import { getFinalScoreSetting } from "../../../lib/settings";
import {
  getAllSquares,
  getAxisNumbers,
  getScores,
  calculateWinners,
  buildGrid,
  countSquaresByUser,
  getPredictionByEmail,
  getAllPredictions,
  calculatePredictionResults,
} from "../../../lib/squares";

const { slug } = Astro.params;

const auth = await getUserWithApproval(Astro.request);

if (!auth) {
  return Astro.redirect("/login");
}

const { user, isApproved } = auth;

const game = await getGameBySlug(slug!);
if (!game) {
  return new Response(null, { status: 404 });
}

const access = await getUserGameAccess(user.email, game.id);
if (!access) {
  return Astro.redirect("/unauthorized");
}

const gameAdmin = access.role === "admin";

const [allSquares, axisNumbers, scores, winners, userPrediction, allPredictions, actualFinalScore, adminGames] = await Promise.all([
  getAllSquares(game.id),
  getAxisNumbers(game.id),
  getScores(),
  calculateWinners(game.id),
  getPredictionByEmail(game.id, user.email),
  getAllPredictions(game.id),
  getFinalScoreSetting(),
  getUserAdminGames(user.email),
]);

const grid = buildGrid(allSquares);
const userSquareCount = await countSquaresByUser(game.id, user.email);
const predictionResults = calculatePredictionResults(
  allPredictions,
  actualFinalScore.seahawks,
  actualFinalScore.patriots,
);
---

<Layout title={`${game.name} - SoupOrBowl 2026`}>
  {game.isLocked ? (
    <SquaresLockedPage
      user={user}
      isAdmin={isApproved && auth.isAdmin}
      isPartyUser={isApproved}
      adminGames={adminGames}
      gameSlug={game.slug}
      gameName={game.name}
      isGameAdmin={gameAdmin}
      grid={grid}
      rowNumbers={axisNumbers.rows}
      colNumbers={axisNumbers.cols}
      scores={scores}
      winners={winners}
      userPrediction={userPrediction}
      predictionResults={predictionResults}
      actualFinalScore={actualFinalScore}
    />
  ) : (
    <SquaresPickingPageWrapper
      user={user}
      isAdmin={isApproved && auth.isAdmin}
      isPartyUser={isApproved}
      adminGames={adminGames}
      gameSlug={game.slug}
      gameName={game.name}
      isGameAdmin={gameAdmin}
      grid={grid}
      userSquareCount={userSquareCount}
      maxSquaresPerUser={game.maxSquaresPerUser}
      userPrediction={userPrediction}
      client:load
    />
  )}
</Layout>
