---
import Layout from "../layouts/Layout.astro";
import { ProfilePage } from "../components/pages";
import { ProfileImageUpload } from "../components/profile";
import { getUserWithApproval } from "../lib/auth";
import { getUserProfile } from "../lib/profile";
import { getUserAdminGames } from "../lib/games";

const auth = await getUserWithApproval(Astro.request);

if (!auth) {
  return Astro.redirect("/login");
}

if (!auth.isApproved) {
  return Astro.redirect("/unauthorized");
}

const { user } = auth;
const [profile, adminGames] = await Promise.all([
  getUserProfile(user.email),
  getUserAdminGames(user.email),
]);
const displayName = profile?.name ?? null;
const customImage = profile?.customImage ?? null;
const googleImage = user.googleImage ?? user.image;
---

<Layout title="Edit Profile - SoupOrBowl 2026">
  <ProfilePage
    user={user}
    displayName={displayName}
    customImage={customImage}
    imageUploadSlot={true}
    isAdmin={auth.isAdmin}
    adminGames={adminGames}
  >
    <ProfileImageUpload
      client:load
      currentImage={customImage}
      googleImage={googleImage}
      userName={displayName ?? user.name}
      userEmail={user.email}
    />
  </ProfilePage>
</Layout>
